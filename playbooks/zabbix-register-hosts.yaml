- name: Register inventory hosts to Zabbix
  hosts: SD-HQ-NMS
  gather_facts: no
  vars:
    ansible_httpapi_validate_certs: false
    zabbix_host_group: "Linux servers"
    zabbix_template_name: "Template OS Linux"
    zabbix_api_token: "8bcddfb1672d63ed31830fc61dc9fcdc64962ec68e540448d46ded1211e9c99c"
    ansible_network_os: zabbix.zabbix.zabbix
    ansible_connection: httpapi
    ansible_httpapi_port: 8080
    ansible_zabbix_url_path: ''

  tasks:
  - name: Create host groups
    zabbix.zabbix.zabbix_group:
      state: present
      host_groups:
        - Ansible
        - Cisco

  - name: Add Linux hosts to Ansible
    become: false
    delegate_to: SD-HQ-NMS

    zabbix.zabbix.zabbix_host:
      host_name: "{{ item }}"
      visible_name: "{{ item }}"
      description: Generated by Ansible
      host_groups:
        - "Linux servers"
        - "Ansible"
      link_templates:
        - "{{ zabbix_template_name }}"
      inventory_mode: manual
      inventory_zabbix:
        location: "{{ location }}"
      interfaces:
        - type: "agent"
          ip: "{{ hostvars[item].ansible_host }}"
          dns: "{{ item }}"
          port: "10050"

      status: enabled
      state: present
      
    loop: "{{ groups['linux_servers'] }}"
