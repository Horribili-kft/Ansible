- name: Register inventory hosts to Zabbix
  hosts: SD-HQ-NMS
  gather_facts: no
  vars:
    ansible_httpapi_validate_certs: false
    zabbix_username: "Admin"
    zabbix_password: "zabbix"
    zabbix_host_group: "Linux servers"
    zabbix_template_name: "Template OS Linux"
  tasks:
  - name: Create a new host or rewrite an existing host's info (Zabbix <= 7.0)
    vars:
      ansible_network_os: community.zabbix.zabbix
      ansible_connection: httpapi
      ansible_httpapi_port: 8080
      ansible_httpapi_validate_certs: false
      ansible_host: 10.0.70.11
    become: false
    delegate_to: SD-HQ-NMS
    community.zabbix.zabbix_host:
      host_name: "{{ item }}"
      visible_name: "{{ item }}"
      description: Generated by Ansible
      host_groups:
        - "Ansible"
      link_templates:
        - "{{ zabbix_template_name }}"
      status: enabled
      state: present
      interfaces:
        - type: 1
          main: 1
          useip: 1
          ip: "{{ hostvars[item].ansible_host }}"
          dns: ""
          port: "10050"
    loop: "{{ groups['linux_servers'] }}"